<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4285f4">
    <meta name="description" content="Speech-to-Braille PWA for learning and translating speech to braille">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <title>Speech to Braille</title>
    
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Additional stylesheets -->
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/figma-ui.css">
    <link rel="stylesheet" href="css/speech-fixes.css">
    <link rel="stylesheet" href="css/ui-enhancements.css"> <!-- Add our new CSS -->
    <style>
        /* Critical inline styles for phase transitions */
        .phase-container {
            display: none;
            transition: opacity 0.5s ease-in-out;
        }
        .phase-active {
            display: block;
            animation: phaseEnter 0.7s ease-in-out;
        }
        @keyframes phaseEnter {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .countdown-timer {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: conic-gradient(#4285f4 0%, transparent 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
        }
        .blink-recording {
            color: white;
            background-color: #ea4335;
            padding: 5px 10px;
            border-radius: 4px;
            animation: blink 1s infinite;
            display: inline-block;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <h1>Speech to Braille</h1>
            <span class="pwa-badge">PWA</span>
        </div>
        <nav>
            <button id="install-button" class="hidden">Install App</button>
            <button id="theme-toggle">üåô</button>
        </nav>
    </header>

    <main>
        <!-- Phase containers -->
        <div id="introduction-phase" class="phase-container">
            <div class="card">
                <h2>Welcome to Speech to Braille</h2>
                <div class="intro-content">
                    <p id="intro-phrase">Loading introduction...</p>
                    <div id="intro-speaking-status" class="speaking-status">
                        <span class="speak-icon">üîä</span> Playing introduction...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PHASE 2: RECORDING (3 seconds) -->
        <div id="recording-phase" class="phase-container">
            <div class="card">
                <h2>Speech Recognition</h2>
                <div class="recording-header">
                    <div id="recording-indicator" class="blink-recording">‚óè Recording (3s)</div>
                    <div class="countdown-timer" id="recording-timer">3</div>
                </div>
                
                <p>Speak into your microphone and I'll listen for words to convert to braille.</p>
                
                <!-- Current sentence display -->
                <div class="speech-output-container">
                    <h3>Current Sentence:</h3>
                    <div id="speech-output" class="speech-output-box">
                        <p id="interim-text"></p>
                        <p id="final-text"></p>
                    </div>
                </div>
                
                <!-- Status indicators -->
                <div id="model-status">
                    <div class="status-row">
                        <span>Model:</span>
                        <span id="model-badge" class="model-badge">Initializing...</span>
                    </div>
                    <div class="status-row">
                        <span>Microphone:</span>
                        <span id="mic-status" class="mic-status">Unavailable</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PHASE 3: OUTPUT (7 seconds) -->
        <div id="output-phase" class="phase-container">
            <div class="card">
                <h2>Braille Output</h2>
                <div class="output-header">
                    <div class="output-indicator">‚óâ Output Mode</div>
                    <div class="countdown-timer" id="output-timer">7</div>
                </div>
                
                <!-- Braille match display -->
                <div id="braille-match" class="braille-match">
                    <!-- No match message -->
                    <div id="no-match-info" style="display: none;">
                        <p class="no-match">No Braille match found. Please try again.</p>
                    </div>
                    
                    <!-- Braille result display -->
                    <div id="braille-result">
                        <div class="match-container">
                            <h3>Matched Word:</h3>
                            <div class="match-row">
                                <span id="matched-word" class="matched-word">None</span>
                                <button id="speak-word-btn" class="speak-btn" title="Speak word">
                                    <span class="speak-icon">üîä</span>
                                </button>
                                <div id="speaking-indicator" class="hidden">Speaking...</div>
                            </div>
                        </div>
                        
                        <div class="braille-info">
                            <div class="info-row">
                                <span class="label">Language:</span>
                                <span id="braille-language">N/A</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Symbol:</span>
                                <span id="braille-symbol"></span>
                            </div>
                            <div class="info-row">
                                <span class="label">Dot Array:</span>
                                <span id="braille-array">[]</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Braille Visualizer -->
                <div id="braille-visualizer" class="braille-visualizer">
                    <div class="dots-container">
                        <div class="dot dot-1" data-dot="1"></div>
                        <div class="dot dot-2" data-dot="2"></div>
                        <div class="dot dot-3" data-dot="3"></div>
                        <div class="dot dot-4" data-dot="4"></div>
                        <div class="dot dot-5" data-dot="5"></div>
                        <div class="dot dot-6" data-dot="6"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bluetooth section -->
        <div class="card">
            <h2>Arduino Connection</h2>
            <div class="bluetooth-container">
                <button id="connect-button" class="connect-btn">Connect to ESP32</button>
                <div id="connection-status" class="status">Not Connected</div>
            </div>
            <div id="device-info" class="device-info hidden">
                <div class="info-row">
                    <span class="label">Device:</span>
                    <span id="device-name">None</span>
                </div>
                <div class="info-row">
                    <span class="label">Status:</span>
                    <span id="device-status">Disconnected</span>
                </div>
            </div>
        </div>
        
        <!-- Braille database status -->
        <div class="card">
            <h2>Braille Database</h2>
            <div id="braille-status" class="status">Initializing...</div>
        </div>
        
        <!-- Troubleshooting section -->
        <div class="card">
            <h2>Troubleshooting</h2>
            <div id="troubleshooting-section" class="troubleshooting-section">
                <details>
                    <summary>Application Status</summary>
                    <div class="details-content">
                        <p>Current Phase: <span id="current-phase-indicator">Introduction</span></p>
                        <p>Recognition Active: <span id="recognition-active-status">No</span></p>
                        <p>Last updated: <span id="last-updated">Loading...</span></p>
                    </div>
                </details>
                
                <details>
                    <summary>Cached Resources</summary>
                    <div class="details-content">
                        <button id="refresh-button">Refresh Cache Info</button>
                        <div id="dynamic-content">
                            <p>Loading cache information...</p>
                        </div>
                    </div>
                </details>
                
                <details>
                    <summary>Speech Recognition Diagnostics</summary>
                    <div class="details-content" id="speech-diagnostics">
                        <p>Checking speech recognition capability...</p>
                    </div>
                </details>
            </div>
        </div>
        
        <!-- Loading indicators -->
        <div id="loading-container" class="loading-container">
            <div class="progress-bar">
                <div id="progress-bar" class="progress progress-striped"></div>
            </div>
            <div id="progress-status" class="progress-status">Loading components...</div>
        </div>
        
        <div id="speech-loading-container" class="loading-container speech-loading-container">
            <div class="progress-bar">
                <div id="speech-progress-bar" class="progress progress-striped"></div>
            </div>
            <div id="speech-loading-status" class="progress-status">Initializing speech recognition...</div>
        </div>
        
        <!-- Hidden compatibility elements for JavaScript -->
        <div style="display: none;">
            <button id="start-speech-btn">Start Speaking</button>
            <button id="stop-speech-btn">Stop</button>
            <select id="speech-method">
                <option value="webspeech">Web Speech API</option>
                <option value="local">Local Model</option>
            </select>
            <div id="cycle-mode-status"></div>
            <div id="cycle-mode-indicator"></div>
        </div>
    </main>
    
    <footer>
        <p>Speech to Braille PWA &copy; 2025</p>
    </footer>

    <!-- Audio resources for phase transitions -->
    <audio id="listening-mode-sound" preload="auto">
        <source src="sounds/listening-mode.mp3" type="audio/mpeg">
    </audio>
    <audio id="output-mode-sound" preload="auto">
        <source src="sounds/output-mode.mp3" type="audio/mpeg">
    </audio>

    <!-- Scripts are loaded in a specific order for dependencies -->
    <script src="js/alternatives/speech-recognition.js"></script>
    <script src="js/braille-translator.js"></script>
    <script src="js/text-to-speech.js"></script>
    <script src="utils/braille-array-formatter.js"></script>
    
    <!-- BLE integration -->
    <script src="js/ble-controller.js"></script>
    <script src="js/ble-ui.js"></script>
    <script src="js/braille-visualizer.js"></script>
    
    <!-- Main application modules -->
    <script src="js/ui-controller.js"></script>
    <script src="js/app.js"></script>
    <script src="js/cache-manager.js"></script>
    <script src="js/sound-effects.js"></script>
    
    <!-- UI Enhancements -->
    <script src="js/ui-enhancements.js"></script>
    <script src="js/theme-switcher.js"></script>
    
    <!-- Diagnostic tools -->
    <script src="js/speech-diagnostics.js"></script>
    
    <!-- Add Figma UI script before closing body tag -->
    <script src="js/figma-ui.js"></script>
    
    <!-- Phase controller script -->
    <script>
        // Phase control management
        document.addEventListener('DOMContentLoaded', function() {
            // Phase control variables
            let currentPhase = 'introduction';
            let phaseTimer = null;
            const PHASE_DURATION = 5000; // 5 seconds per phase
            
            // Flag to track if we've processed the introduction event
            window.hasMovedPastIntro = false;
            
            // Phase elements
            const introPhase = document.getElementById('introduction-phase');
            const recordingPhase = document.getElementById('recording-phase');
            const outputPhase = document.getElementById('output-phase');
            
            // Timer elements
            const recordingTimer = document.getElementById('recording-timer');
            const outputTimer = document.getElementById('output-timer');
            
            // Update recognition status in troubleshooting
            function updateRecognitionStatus(isActive) {
                const statusElement = document.getElementById('recognition-active-status');
                if (statusElement) {
                    statusElement.textContent = isActive ? 'Yes' : 'No';
                    statusElement.style.color = isActive ? '#34a853' : '#ea4335';
                }
            }
            
            // Phase transition functions
            function showPhase(phase) {
                console.log(`Transitioning to phase: ${phase}`);
                
                // If we're trying to transition from introduction to any other phase
                if (currentPhase === 'introduction' && phase !== 'introduction') {
                    window.hasMovedPastIntro = true;
                }
                
                // Update troubleshooting info
                const phaseIndicator = document.getElementById('current-phase-indicator');
                if (phaseIndicator) {
                    phaseIndicator.textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
                }
                
                // Update Arduino about phase change if BLE controller is available
                if (window.bleController && window.bleController.isConnected()) {
                    console.log(`Notifying Arduino of phase change: ${phase}`);
                    window.bleController.setPhase(phase).then(success => {
                        if (!success) {
                            console.warn('Failed to update Arduino about phase change');
                        }
                    });
                }
                
                // Hide all phases
                introPhase.classList.remove('phase-active');
                recordingPhase.classList.remove('phase-active');
                outputPhase.classList.remove('phase-active');
                
                // Show the selected phase
                if (phase === 'introduction') {
                    introPhase.classList.add('phase-active');
                    
                    // Automatically transition to recording phase after 5 seconds
                    // This is a fallback if TTS or events fail
                    setTimeout(() => {
                        if (currentPhase === 'introduction' && !window.hasMovedPastIntro) {
                            console.log('Automatic timeout from introduction phase');
                            window.hasMovedPastIntro = true;
                            showPhase('recording');
                        }
                    }, 5000);
                    
                } else if (phase === 'recording') {
                    recordingPhase.classList.add('phase-active');
                    startPhaseTimer(recordingTimer, 'output');
                    
                    // Clear any previous text to ensure we only show current sentence
                    const finalTextElement = document.getElementById('final-text');
                    if (finalTextElement) finalTextElement.textContent = '';
                    const interimTextElement = document.getElementById('interim-text');
                    if (interimTextElement) interimTextElement.textContent = '';
                    
                    // Play recording sound
                    if (window.textToSpeech && textToSpeech.playRecordingAudio) {
                        textToSpeech.playRecordingAudio();
                    } else if (window.soundEffects) {
                        window.soundEffects.playListeningModeSound();
                    }
                    
                    // Start speech recognition - add a small delay to ensure UI is ready
                    setTimeout(() => {
                        if (window.app && app.startSpeechRecognition) {
                            console.log('Starting speech recognition for recording phase');
                            app.startSpeechRecognition();
                            updateRecognitionStatus(true);
                        }
                    }, 300);
                    
                } else if (phase === 'output') {
                    outputPhase.classList.add('phase-active');
                    startPhaseTimer(outputTimer, 'recording');
                    
                    // Play output sound
                    if (window.textToSpeech && textToSpeech.playOutputAudio) {
                        textToSpeech.playOutputAudio();
                    } else if (window.soundEffects) {
                        window.soundEffects.playOutputModeSound();
                    }
                    
                    // Pause speech recognition
                    if (window.app && app.stopSpeechRecognition) {
                        app.stopSpeechRecognition();
                        updateRecognitionStatus(false);
                    }
                    
                    // Process the current text for braille output
                    processFinalText();
                }
                
                currentPhase = phase;
            }
            
            // Timer countdown function
            function startPhaseTimer(timerElement, nextPhase) {
                if (phaseTimer) clearInterval(phaseTimer);
                
                let secondsLeft = 5;
                timerElement.textContent = secondsLeft;
                timerElement.style.background = 'conic-gradient(#4285f4 0%, transparent 0%)';
                
                phaseTimer = setInterval(() => {
                    secondsLeft--;
                    if (secondsLeft <= 0) {
                        clearInterval(phaseTimer);
                        showPhase(nextPhase);
                    } else {
                        // Update timer display
                        timerElement.textContent = secondsLeft;
                        // Update circular progress
                        const progress = (5 - secondsLeft) / 5 * 100;
                        timerElement.style.background = `conic-gradient(#4285f4 ${progress}%, transparent ${progress}%)`;
                    }
                }, 1000);
            }
            
            // Process the final text to find braille matches
            function processFinalText() {
                const finalTextElement = document.getElementById('final-text');
                if (finalTextElement && finalTextElement.textContent.trim()) {
                    const text = finalTextElement.textContent.trim();
                    
                    // If braille translator is available, process the text
                    if (window.app && app.processSpeechForBraille) {
                        app.processSpeechForBraille(text);
                    }
                }
            }
            
            // Listen for introduction completion - with improved event handling
            window.addEventListener('introCompleted', function(e) {
                console.log('Caught introCompleted event, transitioning to recording phase');
                if (currentPhase === 'introduction') {
                    window.hasMovedPastIntro = true;
                    showPhase('recording');
                }
            });
            
            // Override app's cycle mechanism to use our new phase system
            if (window.app) {
                window.app.startListeningCycle = function() {
                    console.log('startListeningCycle called, current phase:', currentPhase);
                    // Only transition if we're in the introduction phase
                    if (currentPhase === 'introduction') {
                        window.hasMovedPastIntro = true;
                        showPhase('recording');
                    }
                };
            }
            
            // Start with introduction phase
            showPhase('introduction');
            
            // Fallback timer for the entire introduction phase 
            setTimeout(() => {
                if (currentPhase === 'introduction') {
                    console.log('Global fallback timer triggered - forcing transition to recording phase');
                    window.hasMovedPastIntro = true;
                    showPhase('recording');
                }
            }, 7000);
            
            // Make phase control available globally
            window.phaseControl = {
                showPhase,
                getCurrentPhase: () => currentPhase
            };
        });
    </script>
</body>
</html>
